name: Build

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    build-linux:
        runs-on: ubuntu-22.04
        name: Build (Linux)

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: "20"
                    cache: "npm"

            -   name: Install Rust (stable)
                uses: dtolnay/rust-toolchain@stable

            -   name: Cache Rust build artifacts
                uses: Swatinem/rust-cache@v2
                with:
                    workspaces: "./src-tauri -> target"

            -   name: Install system dependencies
                run: |
                    sudo apt-get update
                    sudo apt-get install -y \
                      libwebkit2gtk-4.1-dev \
                      libayatana-appindicator3-dev \
                      librsvg2-dev \
                      patchelf

            -   name: Install npm dependencies
                run: npm ci

            -   name: Build
                run: npm run tauri build

            -   name: Upload build artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: linux-build
                    path: |
                        src-tauri/target/release/bundle/deb/*.deb
                        src-tauri/target/release/bundle/appimage/*.AppImage
                    if-no-files-found: error

    build-windows:
        runs-on: ubuntu-24.04
        name: Build (Windows, cross-compiled)

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: "20"
                    cache: "npm"

            -   name: Install Rust (stable)
                uses: dtolnay/rust-toolchain@stable
                with:
                    targets: x86_64-pc-windows-msvc

            -   name: Install cross-compilation tools
                run: |
                    sudo apt-get update
                    sudo apt-get install -y nsis clang llvm lld
                    cargo install cargo-xwin

            -   name: Cache Rust build artifacts
                uses: Swatinem/rust-cache@v2
                with:
                    workspaces: "./src-tauri -> target"

            -   name: Cache Windows SDK (cargo-xwin)
                uses: actions/cache@v4
                with:
                    path: ~/.cache/cargo-xwin
                    key: xwin-sdk

            -   name: Install npm dependencies
                run: npm ci

            -   name: Build
                env:
                    TAURI_CONFIG: '{"bundle":{"targets":["nsis"]}}'
                run: npm run tauri build -- --runner cargo-xwin --target x86_64-pc-windows-msvc

            -   name: Upload build artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: windows-build
                    path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
                    if-no-files-found: error

    # Uncomment to enable macOS builds (requires macos runner):
    # build-macos:
    #     runs-on: macos-latest
    #     name: Build (macOS)
    #     steps:
    #         -   name: Checkout
    #             uses: actions/checkout@v4
    #         -   name: Setup Node.js
    #             uses: actions/setup-node@v4
    #             with:
    #                 node-version: "20"
    #                 cache: "npm"
    #         -   name: Install Rust (stable)
    #             uses: dtolnay/rust-toolchain@stable
    #         -   name: Cache Rust build artifacts
    #             uses: Swatinem/rust-cache@v2
    #             with:
    #                 workspaces: "./src-tauri -> target"
    #         -   name: Install npm dependencies
    #             run: npm ci
    #         -   name: Build
    #             run: npm run tauri build
    #         -   name: Upload build artifacts
    #             uses: actions/upload-artifact@v4
    #             with:
    #                 name: macos-build
    #                 path: src-tauri/target/release/bundle/dmg/*.dmg
    #                 if-no-files-found: error
