name: Build

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    -   os: ubuntu-22.04
                        label: linux
                        artifact-path: |
                            src-tauri/target/release/bundle/deb/*.deb
                            src-tauri/target/release/bundle/appimage/*.AppImage
                    -   os: windows-latest
                        label: windows
                        artifact-path: |
                            src-tauri/target/release/bundle/msi/*.msi
                            src-tauri/target/release/bundle/nsis/*.exe
                    # Uncomment to enable macOS builds:
                    # - os: macos-latest
                    #   label: macos
                    #   artifact-path: src-tauri/target/release/bundle/dmg/*.dmg

        runs-on: ${{ matrix.os }}
        name: Build (${{ matrix.label }})

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: "20"
                    cache: "npm"

            -   name: Install Rust (stable)
                uses: dtolnay/rust-toolchain@stable

            -   name: Cache Rust build artifacts
                uses: Swatinem/rust-cache@v2
                with:
                    workspaces: "./src-tauri -> target"

            -   name: Install Linux system dependencies
                if: matrix.os == 'ubuntu-22.04'
                run: |
                    sudo apt-get update
                    sudo apt-get install -y \
                      libwebkit2gtk-4.1-dev \
                      libayatana-appindicator3-dev \
                      librsvg2-dev \
                      patchelf

            -   name: Install npm dependencies
                run: npm ci

            -   name: Build
                run: npm run tauri build

            -   name: Upload build artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: ${{ matrix.label }}-build
                    path: ${{ matrix.artifact-path }}
                    if-no-files-found: error
